// ============================================================================
// Repository Trait (추상화 인터페이스)
// ============================================================================
//
// 목적:
//   - Service 레이어가 구체적인 DB 구현에 의존하지 않도록 추상화
//   - 테스트 시 Mock 구현체로 쉽게 교체 가능
//   - "인터페이스에 의존하라" (Dependency Inversion Principle)
//
// 사용 패턴:
//   실제 코드: PgUserRepository (PostgreSQL 사용)
//   테스트 코드: MockUserRepository (가짜 데이터 사용)
//
// ============================================================================

use async_trait::async_trait;
use uuid::Uuid;

// async_trait 매크로:
//   - Rust의 Trait에서는 기본적으로 async fn을 사용할 수 없음
//   - 이 매크로가 async fn을 일반 fn으로 변환해줌 (내부적으로 Boxing 사용)
#[async_trait]
pub trait UserRepository: Send + Sync {
    // Send + Sync:
    //   - Send: 스레드 간 이동 가능
    //   - Sync: 여러 스레드에서 동시 접근 가능
    //   - Axum 같은 멀티스레드 환경에서 필수!

    // -----------------------------------------------------------------------
    // 1. 사용자 존재 여부 확인
    // -----------------------------------------------------------------------
    // 파라미터:
    //   - username: 확인할 사용자 이름 (참조로 받음 - 소유권 이동 불필요)
    // 반환:
    //   - Ok(true): 사용자 존재
    //   - Ok(false): 사용자 없음
    //   - Err: DB 에러
    async fn exists(&self, username: &str) -> Result<bool, sqlx::Error>;

    // -----------------------------------------------------------------------
    // 2. 사용자 저장
    // -----------------------------------------------------------------------
    // 파라미터:
    //   - username: 저장할 사용자 이름
    // 반환:
    //   - Ok(Uuid): 생성된 사용자 ID
    //   - Err: DB 에러
    async fn save(&self, username: &str) -> Result<Uuid, sqlx::Error>;
}

// ============================================================================
// 설계 철학
// ============================================================================
//
// Q: 왜 이렇게 복잡하게 만드나요?
// A: 테스트 가능한 코드를 만들기 위해서입니다.
//
// [Before - Trait 없이]
// service::sign_up(pool, username)  // ← pool에 직접 의존
//   └─ DB 없으면 테스트 불가능!
//
// [After - Trait 사용]
// service::sign_up(repo, username)  // ← Trait에 의존
//   ├─ 실제: PgUserRepository { pool }  → DB 사용
//   └─ 테스트: MockUserRepository { ... } → 가짜 데이터
//
// ============================================================================
